generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                            Int                              @id @default(autoincrement())
  full_name                     String
  phone_number                  String                           @unique
  passcode                      String
  organization                  String?
  position                      String?
  email                         String?
  created_at                    DateTime                         @default(now())
  updated_at                    DateTime                         @updatedAt
  last_login                    DateTime?
  is_active                     Boolean                          @default(true)
  role                          String                           @default("PARTNER")
  contract_type                 Int?
  contract_read                 Boolean                          @default(false)
  contract_read_time            Int?
  configuration_complete        Boolean                          @default(false)
  contract_signed               Boolean                          @default(false)
  contract_signed_date          DateTime?
  ip_address_signed             String?
  signature_data                String?
  last_reset_at                 DateTime?
  contracts_created             contracts[]                      @relation("UserContracts")
  reconfiguration_requests      reconfiguration_requests[]       @relation("UserRequests")
  reviewed_requests             reconfiguration_requests[]       @relation("ReviewerRequests")

  @@index([phone_number])
  @@index([role])
  @@index([contract_signed])
}

model contract_types {
  id                Int         @id @default(autoincrement())
  type_name_khmer   String
  type_name_english String?
  template_file     String?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  contracts         contracts[]
}

model contracts {
  id                     Int                               @id @default(autoincrement())
  contract_number        String                            @unique
  contract_type_id       Int
  party_a_name           String
  party_a_position       String?
  party_a_organization   String?
  party_b_name           String
  party_b_position       String?
  party_b_organization   String?
  start_date             DateTime
  end_date               DateTime
  location               String?
  additional_data        Json?
  status                 String                            @default("draft")
  party_a_signature      String?
  party_a_signed_date    DateTime?
  party_b_signature      String?
  party_b_signed_date    DateTime?
  created_by             String?
  created_at             DateTime                          @default(now())
  updated_at             DateTime                          @updatedAt
  created_by_id          Int?
  attachments            attachments[]
  deliverable_selections contract_deliverable_selections[]
  contract_fields        contract_fields[]
  contract_indicators    contract_indicators[]
  contract_type          contract_types                    @relation(fields: [contract_type_id], references: [id])
  created_by_user        users?                            @relation("UserContracts", fields: [created_by_id], references: [id])
  milestones             milestones[]
}

model contract_fields {
  id          Int       @id @default(autoincrement())
  contract_id Int
  field_name  String
  field_value String?
  field_type  String
  is_required Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  contract    contracts @relation(fields: [contract_id], references: [id], onDelete: Cascade)

  @@unique([contract_id, field_name])
}

model attachments {
  id          Int       @id @default(autoincrement())
  contract_id Int
  file_name   String
  file_path   String
  file_type   String
  file_size   Int
  uploaded_at DateTime  @default(now())
  contract    contracts @relation(fields: [contract_id], references: [id], onDelete: Cascade)
}

model me_indicators {
  id                     Int                  @id @default(autoincrement())
  indicator_code         String               @unique
  indicator_name_khmer   String
  indicator_name_english String?
  indicator_type         String
  measurement_unit       String
  baseline_value         Float?
  target_value           Float
  frequency              String
  contract_type          Int?
  description            String?
  created_at             DateTime             @default(now())
  updated_at             DateTime             @updatedAt
  activities             me_activities[]
  data_collections       me_data_collection[]
}

model me_activities {
  id                    Int                  @id @default(autoincrement())
  activity_code         String               @unique
  activity_name_khmer   String
  activity_name_english String?
  indicator_id          Int
  contract_id           Int?
  planned_start         DateTime
  planned_end           DateTime
  actual_start          DateTime?
  actual_end            DateTime?
  status                String               @default("planned")
  budget_allocated      Float?
  budget_spent          Float?
  responsible_person    String?
  location              String?
  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt
  indicator             me_indicators        @relation(fields: [indicator_id], references: [id])
  data_collections      me_data_collection[]
  milestones            me_milestones[]
}

model me_milestones {
  id                  Int           @id @default(autoincrement())
  milestone_name      String
  activity_id         Int
  due_date            DateTime
  completion_date     DateTime?
  status              String        @default("pending")
  progress_percentage Int           @default(0)
  deliverables        String?
  notes               String?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  activity            me_activities @relation(fields: [activity_id], references: [id])
}

model me_beneficiaries {
  id                Int                      @id @default(autoincrement())
  beneficiary_code  String                   @unique
  full_name         String
  gender            String
  age               Int?
  phone_number      String?
  location_province String
  location_district String
  location_commune  String?
  location_village  String?
  school_name       String?
  grade_level       String?
  teacher_type      String?
  special_needs     Boolean                  @default(false)
  notes             String?
  created_at        DateTime                 @default(now())
  updated_at        DateTime                 @updatedAt
  data_collections  me_data_collection[]
  trainings         me_training_attendance[]
}

model me_data_collection {
  id                  Int               @id @default(autoincrement())
  indicator_id        Int
  activity_id         Int?
  beneficiary_id      Int?
  collection_date     DateTime
  value_numeric       Float?
  value_text          String?
  value_boolean       Boolean?
  data_source         String?
  collector_name      String?
  collector_id        Int?
  verification_status String            @default("pending")
  verified_by         String?
  verified_date       DateTime?
  location_province   String?
  location_district   String?
  notes               String?
  attachments         Json?
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt
  activity            me_activities?    @relation(fields: [activity_id], references: [id])
  beneficiary         me_beneficiaries? @relation(fields: [beneficiary_id], references: [id])
  indicator           me_indicators     @relation(fields: [indicator_id], references: [id])

  @@index([collection_date])
  @@index([indicator_id, collection_date])
}

model me_training_attendance {
  id                 Int              @id @default(autoincrement())
  training_name      String
  training_date      DateTime
  beneficiary_id     Int
  attendance_status  String
  pre_test_score     Float?
  post_test_score    Float?
  certificate_issued Boolean          @default(false)
  feedback_score     Int?
  notes              String?
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  beneficiary        me_beneficiaries @relation(fields: [beneficiary_id], references: [id])

  @@index([training_date])
  @@index([beneficiary_id])
}

model me_reports {
  id                  Int       @id @default(autoincrement())
  report_type         String
  report_period_start DateTime
  report_period_end   DateTime
  generated_by        String
  generated_date      DateTime  @default(now())
  report_data         Json
  summary             String?
  recommendations     String?
  attachments         Json?
  status              String    @default("draft")
  approved_by         String?
  approved_date       DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
}

model contract_deliverables {
  id                        Int                               @id @default(autoincrement())
  contract_type             Int
  deliverable_number        Int
  deliverable_title_khmer   String
  deliverable_title_english String?
  timeline                  String
  activities_text           String?
  order_index               Int                               @default(0)
  is_active                 Boolean                           @default(true)
  created_at                DateTime                          @default(now())
  updated_at                DateTime                          @updatedAt
  selections                contract_deliverable_selections[]
  options                   deliverable_options[]

  @@unique([contract_type, deliverable_number])
  @@index([contract_type])
  @@index([is_active])
}

model deliverable_options {
  id                  Int                               @id @default(autoincrement())
  deliverable_id      Int
  option_number       Int
  option_text_khmer   String
  option_text_english String?
  condition_type      String
  baseline_percentage Float?
  target_percentage   Float?
  order_index         Int                               @default(0)
  is_active           Boolean                           @default(true)
  created_at          DateTime                          @default(now())
  updated_at          DateTime                          @updatedAt
  selections          contract_deliverable_selections[]
  deliverable         contract_deliverables             @relation(fields: [deliverable_id], references: [id], onDelete: Cascade)

  @@unique([deliverable_id, option_number])
  @@index([deliverable_id])
  @@index([is_active])
}

model contract_deliverable_selections {
  id                 Int                   @id @default(autoincrement())
  contract_id        Int
  deliverable_id     Int
  selected_option_id Int
  selected_at        DateTime              @default(now())
  selected_by        String?
  notes              String?
  created_at         DateTime              @default(now())
  updated_at         DateTime              @updatedAt
  contract           contracts             @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  deliverable        contract_deliverables @relation(fields: [deliverable_id], references: [id], onDelete: Cascade)
  selected_option    deliverable_options   @relation(fields: [selected_option_id], references: [id], onDelete: Cascade)

  @@unique([contract_id, deliverable_id])
  @@index([contract_id])
  @@index([deliverable_id])
  @@index([selected_option_id])
}

model indicators {
  id                   Int                   @id @default(autoincrement())
  indicator_code       String                @unique
  indicator_number     Int                   @unique
  indicator_name_km    String
  indicator_name_en    String?
  target_percentage    Float
  baseline_percentage  Float
  is_reduction_target  Boolean               @default(false)
  implementation_start String
  implementation_end   String
  calculation_rules    Json
  description_km       String?
  description_en       String?
  is_active            Boolean               @default(true)
  created_at           DateTime              @default(now())
  updated_at           DateTime              @updatedAt
  contract_indicators  contract_indicators[]
  milestones           milestones[]

  @@index([indicator_code])
  @@index([is_active])
}

model contract_indicators {
  id                          Int          @id @default(autoincrement())
  contract_id                 Int
  indicator_id                Int
  baseline_percentage         Float
  baseline_source             String?
  baseline_date               DateTime
  baseline_notes              String?
  target_percentage           Float
  target_date                 DateTime
  calculation_method          String       @default("based_on_baseline")
  custom_target_justification String?
  justification_km            String?
  justification_en            String?
  selected_at                 DateTime     @default(now())
  selected_by                 String?
  created_at                  DateTime     @default(now())
  updated_at                  DateTime     @updatedAt
  selected_rule               Int?
  contract                    contracts    @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  indicator                   indicators   @relation(fields: [indicator_id], references: [id], onDelete: Cascade)
  milestones                  milestones[]

  @@unique([contract_id, indicator_id])
  @@index([contract_id])
  @@index([indicator_id])
}

model milestones {
  id                       Int                      @id @default(autoincrement())
  milestone_code           String                   @unique
  contract_id              Int
  indicator_id             Int
  contract_indicator_id    Int
  milestone_name_km        String
  milestone_name_en        String?
  milestone_description_km String?
  milestone_description_en String?
  milestone_type           String                   @default("quantitative")
  milestone_category       String?
  planned_start_date       DateTime
  planned_end_date         DateTime
  actual_start_date        DateTime?
  actual_end_date          DateTime?
  milestone_duration_days  Int?
  baseline_value           Float
  target_value             Float
  current_value            Float?
  measurement_unit         String                   @default("percentage")
  target_increase          Float?
  is_reduction_target      Boolean                  @default(false)
  achievement_percentage   Float                    @default(0)
  last_updated             DateTime?
  data_source              String?
  verification_method      String?
  overall_status           String                   @default("not_started")
  health_indicator         String                   @default("on_track")
  risk_level               String                   @default("low")
  is_delayed               Boolean                  @default(false)
  days_delayed             Int                      @default(0)
  completion_date          DateTime?
  data_quality_score       Float?
  created_at               DateTime                 @default(now())
  updated_at               DateTime                 @updatedAt
  activities               milestone_activities[]
  deliverables             milestone_deliverables[]
  contract                 contracts                @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  contract_indicator       contract_indicators      @relation(fields: [contract_indicator_id], references: [id], onDelete: Cascade)
  indicator                indicators               @relation(fields: [indicator_id], references: [id])
  monitoring_visits        monitoring_visits[]
  progress_reports         progress_reports[]

  @@index([contract_id])
  @@index([indicator_id])
  @@index([overall_status])
  @@index([health_indicator])
}

model milestone_activities {
  id                    Int        @id @default(autoincrement())
  activity_code         String     @unique
  milestone_id          Int
  activity_name_km      String
  activity_name_en      String?
  activity_description  String?
  responsible_person    String
  start_date            DateTime
  end_date              DateTime
  status                String     @default("not_started")
  completion_percentage Int        @default(0)
  budget_allocated      Float?
  budget_spent          Float?
  location              String?
  notes                 String?
  created_at            DateTime   @default(now())
  updated_at            DateTime   @updatedAt
  milestone             milestones @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  @@index([milestone_id])
  @@index([status])
}

model milestone_deliverables {
  id                  Int        @id @default(autoincrement())
  deliverable_code    String     @unique
  milestone_id        Int
  deliverable_name_km String
  deliverable_name_en String?
  deliverable_type    String
  due_date            DateTime
  status              String     @default("pending")
  submission_date     DateTime?
  file_attachments    Json?
  review_status       String     @default("not_reviewed")
  reviewer_comments   String?
  description         String?
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  milestone           milestones @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  @@index([milestone_id])
  @@index([status])
  @@index([due_date])
}

model progress_reports {
  id                   Int        @id @default(autoincrement())
  report_code          String     @unique
  milestone_id         Int
  reporting_date       DateTime
  reporting_period     String
  reported_value       Float?
  cumulative_progress  Float      @default(0)
  narrative_report_km  String?
  narrative_report_en  String?
  challenges_km        String?
  challenges_en        String?
  next_steps_km        String?
  next_steps_en        String?
  supporting_documents Json?
  verified             Boolean    @default(false)
  verified_by          String?
  verified_date        DateTime?
  verification_notes   String?
  created_at           DateTime   @default(now())
  updated_at           DateTime   @updatedAt
  milestone            milestones @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  @@index([milestone_id])
  @@index([reporting_date])
  @@index([verified])
}

model monitoring_visits {
  id                Int        @id @default(autoincrement())
  visit_code        String     @unique
  milestone_id      Int
  visit_date        DateTime
  visit_location    String
  visit_team        Json?
  schools_visited   Json?
  observations      String?
  data_verification Json?
  recommendations   String?
  follow_up_actions String?
  attachments       Json?
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  milestone         milestones @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  @@index([milestone_id])
  @@index([visit_date])
}

model reconfiguration_requests {
  id                      Int       @id @default(autoincrement())
  user_id                 Int
  contract_type           Int
  request_reason          String
  current_selections      Json
  requested_changes       String?
  status                  String    @default("pending")
  reviewed_by_id          Int?
  reviewed_at             DateTime?
  reviewer_notes          String?
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  user                    users     @relation("UserRequests", fields: [user_id], references: [id], onDelete: Cascade)
  reviewed_by             users?    @relation("ReviewerRequests", fields: [reviewed_by_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([created_at])
}

model content_texts {
  id           Int      @id @default(autoincrement())
  key          String   @unique
  text_khmer   String
  text_english String?
  category     String
  description  String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([category])
  @@index([key])
  @@index([is_active])
}
