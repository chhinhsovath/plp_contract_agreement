generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                    Int       @id @default(autoincrement())
  full_name             String
  phone_number          String    @unique
  passcode              String    // Last 4 digits of phone
  role                  String    @default("PARTNER") // SUPER_ADMIN, ADMIN, MANAGER, COORDINATOR, OFFICER, VIEWER, PARTNER
  contract_type         Int?      // User's primary contract type (1-5)
  organization          String?
  position              String?
  email                 String?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  last_login            DateTime?
  is_active             Boolean   @default(true)

  // Contract signing fields
  contract_signed       Boolean   @default(false)
  contract_signed_date  DateTime?
  signature_data        String?   @db.Text // Store signature image as base64
  contract_read_time    Int?      // Time spent reading in seconds
  ip_address_signed     String?   // IP address when signed

  // Demo user tracking
  last_reset_at         DateTime? // Track when demo user was last reset

  contracts_created contracts[] @relation("UserContracts")

  @@index([phone_number])
  @@index([role])
  @@index([contract_signed])
}

model contract_types {
  id                Int        @id @default(autoincrement())
  type_name_khmer   String
  type_name_english String?
  template_file     String?
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  contracts         contracts[]
}

model contracts {
  id                      Int                @id @default(autoincrement())
  contract_number         String             @unique
  contract_type_id        Int
  contract_type           contract_types     @relation(fields: [contract_type_id], references: [id])

  // Party A (ភាគី ក)
  party_a_name            String
  party_a_position        String?
  party_a_organization    String?

  // Party B (ភាគី ខ)
  party_b_name            String
  party_b_position        String?
  party_b_organization    String?

  // Contract details
  start_date              DateTime
  end_date                DateTime
  location                String?

  // Additional fields based on contract type
  additional_data         Json?

  // Status
  status                  String             @default("draft") // draft, pending_signature, signed, completed

  // Signatures
  party_a_signature       String?            // Base64 encoded signature
  party_a_signed_date     DateTime?
  party_b_signature       String?            // Base64 encoded signature
  party_b_signed_date     DateTime?

  // Metadata
  created_by              String?
  created_by_user         users?             @relation("UserContracts", fields: [created_by_id], references: [id])
  created_by_id           Int?
  created_at              DateTime           @default(now())
  updated_at              DateTime           @updatedAt

  contract_fields         contract_fields[]
  attachments            attachments[]
  deliverable_selections  contract_deliverable_selections[]
  contract_indicators     contract_indicators[]
  milestones             milestones[]
}

model contract_fields {
  id              Int        @id @default(autoincrement())
  contract_id     Int
  contract        contracts  @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  field_name      String
  field_value     String?
  field_type      String     // text, number, date, dropdown
  is_required     Boolean    @default(false)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  @@unique([contract_id, field_name])
}

model attachments {
  id              Int        @id @default(autoincrement())
  contract_id     Int
  contract        contracts  @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  file_name       String
  file_path       String
  file_type       String
  file_size       Int
  uploaded_at     DateTime   @default(now())
}

// ============================================
// M&E (Monitoring & Evaluation) Models
// ============================================

model me_indicators {
  id                    Int                     @id @default(autoincrement())
  indicator_code        String                  @unique
  indicator_name_khmer  String
  indicator_name_english String?
  indicator_type        String                  // output, outcome, impact
  measurement_unit      String                  // number, percentage, text, boolean
  baseline_value        Float?
  target_value          Float
  frequency             String                  // monthly, quarterly, annually
  contract_type         Int?                    // Related to which contract type (1-5)
  description           String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  activities            me_activities[]
  data_collections      me_data_collection[]
}

model me_activities {
  id                    Int                     @id @default(autoincrement())
  activity_code         String                  @unique
  activity_name_khmer   String
  activity_name_english String?
  indicator_id          Int
  indicator             me_indicators           @relation(fields: [indicator_id], references: [id])
  contract_id           Int?
  planned_start         DateTime
  planned_end           DateTime
  actual_start          DateTime?
  actual_end            DateTime?
  status                String                  @default("planned") // planned, ongoing, completed, delayed, cancelled
  budget_allocated      Float?
  budget_spent          Float?
  responsible_person    String?
  location              String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  milestones            me_milestones[]
  data_collections      me_data_collection[]
}

model me_milestones {
  id                    Int                     @id @default(autoincrement())
  milestone_name        String
  activity_id           Int
  activity              me_activities           @relation(fields: [activity_id], references: [id])
  due_date              DateTime
  completion_date       DateTime?
  status                String                  @default("pending") // pending, achieved, overdue
  progress_percentage   Int                     @default(0)
  deliverables          String?                 // JSON array of deliverables
  notes                 String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt
}

model me_beneficiaries {
  id                    Int                     @id @default(autoincrement())
  beneficiary_code      String                  @unique
  full_name             String
  gender                String                  // male, female, other
  age                   Int?
  phone_number          String?
  location_province     String
  location_district     String
  location_commune      String?
  location_village      String?
  school_name           String?
  grade_level           String?
  teacher_type          String?                 // primary, secondary, etc.
  special_needs         Boolean                 @default(false)
  notes                 String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  data_collections      me_data_collection[]
  trainings             me_training_attendance[]
}

model me_data_collection {
  id                    Int                     @id @default(autoincrement())
  indicator_id          Int
  indicator             me_indicators           @relation(fields: [indicator_id], references: [id])
  activity_id           Int?
  activity              me_activities?          @relation(fields: [activity_id], references: [id])
  beneficiary_id        Int?
  beneficiary           me_beneficiaries?       @relation(fields: [beneficiary_id], references: [id])
  collection_date       DateTime
  value_numeric         Float?
  value_text            String?
  value_boolean         Boolean?
  data_source           String?                 // survey, observation, document, system
  collector_name        String?
  collector_id          Int?
  verification_status   String                  @default("pending") // pending, verified, rejected
  verified_by           String?
  verified_date         DateTime?
  location_province     String?
  location_district     String?
  notes                 String?
  attachments           Json?                   // JSON array of attachment URLs
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  @@index([collection_date])
  @@index([indicator_id, collection_date])
}

model me_training_attendance {
  id                    Int                     @id @default(autoincrement())
  training_name         String
  training_date         DateTime
  beneficiary_id        Int
  beneficiary           me_beneficiaries        @relation(fields: [beneficiary_id], references: [id])
  attendance_status     String                  // present, absent, excused
  pre_test_score        Float?
  post_test_score       Float?
  certificate_issued    Boolean                 @default(false)
  feedback_score        Int?                    // 1-5 rating
  notes                 String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt

  @@index([training_date])
  @@index([beneficiary_id])
}

model me_reports {
  id                    Int                     @id @default(autoincrement())
  report_type           String                  // monthly, quarterly, annual, ad-hoc
  report_period_start   DateTime
  report_period_end     DateTime
  generated_by          String
  generated_date        DateTime                @default(now())
  report_data           Json                    // Aggregated data snapshot
  summary               String?
  recommendations       String?
  attachments           Json?                   // JSON array of attachment URLs
  status                String                  @default("draft") // draft, submitted, approved
  approved_by           String?
  approved_date         DateTime?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt
}

// ============================================
// Contract Deliverables & Options Models
// For Agreement Types 4 & 5
// ============================================

model contract_deliverables {
  id                          Int                             @id @default(autoincrement())
  contract_type               Int                             // 4 or 5
  deliverable_number          Int                             // 1-5
  deliverable_title_khmer     String                          @db.Text
  deliverable_title_english   String?                         @db.Text
  timeline                    String                          // ខែតុលា-ខែវិច្ឆិកា ឆ្នាំ២០២៥
  activities_text             String?                         @db.Text // For Agreement 5 only: សកម្មភាពនាយកសាលាអនុវត្ត
  order_index                 Int                             @default(0)
  is_active                   Boolean                         @default(true)
  created_at                  DateTime                        @default(now())
  updated_at                  DateTime                        @updatedAt

  options                     deliverable_options[]
  selections                  contract_deliverable_selections[]

  @@unique([contract_type, deliverable_number])
  @@index([contract_type])
  @@index([is_active])
}

model deliverable_options {
  id                          Int                             @id @default(autoincrement())
  deliverable_id              Int
  deliverable                 contract_deliverables           @relation(fields: [deliverable_id], references: [id], onDelete: Cascade)
  option_number               Int                             // 1, 2, or 3
  option_text_khmer           String                          @db.Text
  option_text_english         String?                         @db.Text
  condition_type              String                          // "less_than", "equal", "greater_or_equal"
  baseline_percentage         Float?                          // For conditional logic
  target_percentage           Float?                          // Target value
  order_index                 Int                             @default(0)
  is_active                   Boolean                         @default(true)
  created_at                  DateTime                        @default(now())
  updated_at                  DateTime                        @updatedAt

  selections                  contract_deliverable_selections[]

  @@unique([deliverable_id, option_number])
  @@index([deliverable_id])
  @@index([is_active])
}

model contract_deliverable_selections {
  id                          Int                             @id @default(autoincrement())
  contract_id                 Int
  contract                    contracts                       @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  deliverable_id              Int
  deliverable                 contract_deliverables           @relation(fields: [deliverable_id], references: [id], onDelete: Cascade)
  selected_option_id          Int
  selected_option             deliverable_options             @relation(fields: [selected_option_id], references: [id], onDelete: Cascade)
  selected_at                 DateTime                        @default(now())
  selected_by                 String?                         // User who made the selection
  notes                       String?                         @db.Text
  created_at                  DateTime                        @default(now())
  updated_at                  DateTime                        @updatedAt

  @@unique([contract_id, deliverable_id])
  @@index([contract_id])
  @@index([deliverable_id])
  @@index([selected_option_id])
}

// ============================================
// Education Partner Performance Tracking System
// Based on PRD: 5 Performance Indicators System
// ============================================

model indicators {
  id                      Int                       @id @default(autoincrement())
  indicator_code          String                    @unique // IND-001 to IND-005
  indicator_number        Int                       @unique // 1 to 5
  indicator_name_km       String                    @db.Text
  indicator_name_en       String?                   @db.Text
  target_percentage       Float
  baseline_percentage     Float
  is_reduction_target     Boolean                   @default(false) // true for indicator 4
  implementation_start    String                    // "2025-10"
  implementation_end      String                    // "2025-11"
  calculation_rules       Json                      // Stores calculation logic array
  description_km          String?                   @db.Text
  description_en          String?                   @db.Text
  is_active               Boolean                   @default(true)
  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  contract_indicators     contract_indicators[]
  milestones              milestones[]

  @@index([indicator_code])
  @@index([is_active])
}

model contract_indicators {
  id                      Int                       @id @default(autoincrement())
  contract_id             Int
  contract                contracts                 @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  indicator_id            Int
  indicator               indicators                @relation(fields: [indicator_id], references: [id], onDelete: Cascade)

  // Partner's baseline data
  baseline_percentage     Float
  baseline_source         String?
  baseline_date           DateTime
  baseline_notes          String?                   @db.Text

  // Target commitment
  target_percentage       Float
  target_date             DateTime
  calculation_method      String                    @default("based_on_baseline") // "based_on_baseline", "custom"
  custom_target_justification String?               @db.Text

  // Selection metadata
  justification_km        String?                   @db.Text
  justification_en        String?                   @db.Text
  selected_at             DateTime                  @default(now())
  selected_by             String?

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  milestones              milestones[]

  // IMPORTANT: Each indicator can only be selected ONCE per contract
  @@unique([contract_id, indicator_id])
  @@index([contract_id])
  @@index([indicator_id])
}

model milestones {
  id                      Int                       @id @default(autoincrement())
  milestone_code          String                    @unique // MS-001, MS-002, etc.
  contract_id             Int
  contract                contracts                 @relation(fields: [contract_id], references: [id], onDelete: Cascade)
  indicator_id            Int
  indicator               indicators                @relation(fields: [indicator_id], references: [id])
  contract_indicator_id   Int
  contract_indicator      contract_indicators       @relation(fields: [contract_indicator_id], references: [id], onDelete: Cascade)

  // Milestone details
  milestone_name_km       String
  milestone_name_en       String?
  milestone_description_km String?                  @db.Text
  milestone_description_en String?                  @db.Text
  milestone_type          String                    @default("quantitative") // quantitative, qualitative
  milestone_category      String?                   // enrollment, infrastructure, quality, etc.

  // Timeline
  planned_start_date      DateTime
  planned_end_date        DateTime
  actual_start_date       DateTime?
  actual_end_date         DateTime?
  milestone_duration_days Int?

  // Targets and progress
  baseline_value          Float
  target_value            Float
  current_value           Float?
  measurement_unit        String                    @default("percentage")
  target_increase         Float?                    // For increase indicators
  is_reduction_target     Boolean                   @default(false)

  // Progress tracking
  achievement_percentage  Float                     @default(0)
  last_updated            DateTime?
  data_source             String?
  verification_method     String?

  // Status
  overall_status          String                    @default("not_started") // not_started, in_progress, completed, delayed
  health_indicator        String                    @default("on_track") // on_track, at_risk, critical
  risk_level              String                    @default("low") // low, medium, high
  is_delayed              Boolean                   @default(false)
  days_delayed            Int                       @default(0)
  completion_date         DateTime?

  // Quality verification
  data_quality_score      Float?

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  activities              milestone_activities[]
  deliverables            milestone_deliverables[]
  progress_reports        progress_reports[]
  monitoring_visits       monitoring_visits[]

  @@index([contract_id])
  @@index([indicator_id])
  @@index([overall_status])
  @@index([health_indicator])
}

model milestone_activities {
  id                      Int                       @id @default(autoincrement())
  activity_code           String                    @unique // ACT-001, ACT-002, etc.
  milestone_id            Int
  milestone               milestones                @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  activity_name_km        String
  activity_name_en        String?
  activity_description    String?                   @db.Text
  responsible_person      String
  start_date              DateTime
  end_date                DateTime
  status                  String                    @default("not_started") // not_started, ongoing, completed, delayed, cancelled
  completion_percentage   Int                       @default(0)
  budget_allocated        Float?
  budget_spent            Float?
  location                String?
  notes                   String?                   @db.Text

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  @@index([milestone_id])
  @@index([status])
}

model milestone_deliverables {
  id                      Int                       @id @default(autoincrement())
  deliverable_code        String                    @unique // DEL-001, DEL-002, etc.
  milestone_id            Int
  milestone               milestones                @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  deliverable_name_km     String
  deliverable_name_en     String?
  deliverable_type        String                    // report, data, document, photo_evidence
  due_date                DateTime
  status                  String                    @default("pending") // pending, submitted, approved, rejected
  submission_date         DateTime?
  file_attachments        Json?                     // Array of file paths
  review_status           String                    @default("not_reviewed") // not_reviewed, under_review, approved, rejected
  reviewer_comments       String?                   @db.Text
  description             String?                   @db.Text

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  @@index([milestone_id])
  @@index([status])
  @@index([due_date])
}

model progress_reports {
  id                      Int                       @id @default(autoincrement())
  report_code             String                    @unique // RPT-001, RPT-002, etc.
  milestone_id            Int
  milestone               milestones                @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  reporting_date          DateTime
  reporting_period        String                    // "Month 1", "Q1", etc.
  reported_value          Float?
  cumulative_progress     Float                     @default(0)

  narrative_report_km     String?                   @db.Text
  narrative_report_en     String?                   @db.Text
  challenges_km           String?                   @db.Text
  challenges_en           String?                   @db.Text
  next_steps_km           String?                   @db.Text
  next_steps_en           String?                   @db.Text

  supporting_documents    Json?                     // Array of file paths

  verified                Boolean                   @default(false)
  verified_by             String?
  verified_date           DateTime?
  verification_notes      String?                   @db.Text

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  @@index([milestone_id])
  @@index([reporting_date])
  @@index([verified])
}

model monitoring_visits {
  id                      Int                       @id @default(autoincrement())
  visit_code              String                    @unique // VIS-001, VIS-002, etc.
  milestone_id            Int
  milestone               milestones                @relation(fields: [milestone_id], references: [id], onDelete: Cascade)

  visit_date              DateTime
  visit_location          String
  visit_team              Json?                     // Array of team members
  schools_visited         Json?                     // Array of school names
  observations            String?                   @db.Text
  data_verification       Json?                     // Verification results
  recommendations         String?                   @db.Text
  follow_up_actions       String?                   @db.Text
  attachments             Json?                     // Array of file paths

  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  @@index([milestone_id])
  @@index([visit_date])
}